<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compare Pro | –ê–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤</title>
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
    </style>
</head>
<body>
    <!-- ... (–≤–µ—Å—å HTML –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->

    <script>
        // ... (–±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

        function analyzeImages(sensitivity, minArea) {
            try {
                updateProgress(10, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...');

                const canvas1 = document.createElement('canvas');
                const canvas2 = document.createElement('canvas');
                const ctx1 = canvas1.getContext('2d');
                const ctx2 = canvas2.getContext('2d');

                const width = 800;
                const height = Math.floor((width / image1.naturalWidth) * image1.naturalHeight);

                canvas1.width = canvas2.width = width;
                canvas1.height = canvas2.height = height;

                updateProgress(30, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...');
                ctx1.drawImage(image1, 0, 0, width, height);
                ctx2.drawImage(image2, 0, 0, width, height);

                updateProgress(50, '–î–µ—Ç–µ–∫—Ü–∏—è –ª–∏—Ü–∞ –∏ –∞–Ω–∞–ª–∏–∑...');
                
                const imageData1 = ctx1.getImageData(0, 0, width, height);
                const imageData2 = ctx2.getImageData(0, 0, width, height);
                const data1 = imageData1.data;
                const data2 = imageData2.data;

                // –ö–∞—Ä—Ç–∞ —Ä–∞–∑–ª–∏—á–∏–π
                const diffMap = new Uint8ClampedArray(width * height);
                let totalDifferences = 0;

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –ª–∏—Ü–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Ü–µ–Ω—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
                const faceCenterX = width / 2;
                const faceCenterY = height / 2;
                const faceRadius = Math.min(width, height) * 0.3;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        
                        const r1 = data1[idx];
                        const g1 = data1[idx + 1];
                        const b1 = data1[idx + 2];
                        
                        const r2 = data2[idx];
                        const g2 = data2[idx + 1];
                        const b2 = data2[idx + 2];

                        // –í—ã—á–∏—Å–ª—è–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Ä–∞–∑–Ω–∏—Ü—É
                        const colorDiff = (
                            Math.abs(r1 - r2) + 
                            Math.abs(g1 - g2) + 
                            Math.abs(b1 - b2)
                        ) / (3 * 255);

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Å –ø–∏–∫—Å–µ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è
                        let pixelWeight = 1.0;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–∏–∫—Å–µ–ª—å –≤ –æ–±–ª–∞—Å—Ç–∏ –ª–∏—Ü–∞
                        const distanceToCenter = Math.sqrt(
                            Math.pow(x - faceCenterX, 2) + 
                            Math.pow(y - faceCenterY, 2)
                        );
                        
                        if (distanceToCenter < faceRadius) {
                            // –ü–∏–∫—Å–µ–ª—å –≤ –æ–±–ª–∞—Å—Ç–∏ –ª–∏—Ü–∞ - –±–æ–ª—å—à–∏–π –≤–µ—Å
                            pixelWeight = 3.0;
                        } else if (distanceToCenter < faceRadius * 1.5) {
                            // –ü–∏–∫—Å–µ–ª—å —Ä—è–¥–æ–º —Å –ª–∏—Ü–æ–º - —Å—Ä–µ–¥–Ω–∏–π –≤–µ—Å
                            pixelWeight = 1.5;
                        }

                        if (colorDiff > sensitivity) {
                            diffMap[y * width + x] = 255;
                            totalDifferences += pixelWeight; // –£—á–∏—Ç—ã–≤–∞–µ–º –≤–µ—Å
                        }
                    }

                    if (y % 10 === 0) {
                        updateProgress(50 + (y / height * 30), `–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${Math.round(y / height * 100)}%`);
                    }
                }

                updateProgress(80, '–ü–æ–∏—Å–∫ –∑–Ω–∞—á–∏–º—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π...');
                
                differenceAreas = findConnectedComponents(diffMap, width, height, minArea);

                updateProgress(90, '–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...');
                
                const resultCanvas = document.createElement('canvas');
                resultCanvas.width = width;
                resultCanvas.height = height;
                const resultCtx = resultCanvas.getContext('2d');
                
                resultCtx.drawImage(canvas1, 0, 0);

                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–∏—è
                resultCtx.strokeStyle = '#ff4757';
                resultCtx.lineWidth = 3;
                resultCtx.fillStyle = 'rgba(255, 71, 87, 0.2)';
                
                // –†–∏—Å—É–µ–º –æ–±–ª–∞—Å—Ç—å –ª–∏—Ü–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
                resultCtx.beginPath();
                resultCtx.arc(faceCenterX, faceCenterY, faceRadius, 0, 2 * Math.PI);
                resultCtx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
                resultCtx.stroke();
                
                resultCtx.strokeStyle = '#ff4757';
                
                differenceAreas.forEach(area => {
                    let minX = width, minY = height, maxX = 0, maxY = 0;
                    for (const [x, y] of area) {
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }

                    resultCtx.beginPath();
                    resultCtx.rect(minX, minY, maxX - minX, maxY - minY);
                    resultCtx.stroke();
                    resultCtx.fill();
                });

                // –ü–†–ê–í–ò–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ –°–•–û–ñ–ï–°–¢–ò
                const totalPixels = width * height;
                
                // –í–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å: —É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–∏—Ü–µ –≤–∞–∂–Ω–µ–µ
                let weightedSimilarity = 0;
                let maxPossibleWeight = 0;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const distanceToCenter = Math.sqrt(
                            Math.pow(x - faceCenterX, 2) + 
                            Math.pow(y - faceCenterY, 2)
                        );
                        
                        let pixelWeight = 1.0;
                        if (distanceToCenter < faceRadius) {
                            pixelWeight = 3.0;
                        } else if (distanceToCenter < faceRadius * 1.5) {
                            pixelWeight = 1.5;
                        }

                        maxPossibleWeight += pixelWeight;
                        
                        if (diffMap[y * width + x] === 0) {
                            weightedSimilarity += pixelWeight;
                        }
                    }
                }

                const similarity = (weightedSimilarity / maxPossibleWeight) * 100;
                const similarityRounded = Math.max(0, Math.min(100, Math.round(similarity * 10) / 10));

                analysisResult = {
                    similarity: similarityRounded,
                    diffCanvas: resultCanvas,
                    totalPixels: totalPixels,
                    changedPixels: totalDifferences,
                    areasCount: differenceAreas.length,
                    analysisTime: ((Date.now() - startTime) / 1000).toFixed(1),
                    resolution: `${width}√ó${height}px`,
                    faceArea: Math.round(Math.PI * Math.pow(faceRadius, 2))
                };

                updateProgress(100, '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!');
                
                setTimeout(() => {
                    document.getElementById('progress-container').style.display = 'none';
                    displayResult();
                }, 500);

            } catch (error) {
                console.error('Analysis error:', error);
                showError('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message);
                document.getElementById('progress-container').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayResult() {
            if (!analysisResult) return;

            // ... (–∫–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤) ...

            detailedStats.innerHTML = `
                <p><strong>–û–±–ª–∞—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:</strong> ${analysisResult.resolution}</p>
                <p><strong>–û–±–ª–∞—Å—Ç—å –ª–∏—Ü–∞:</strong> ${analysisResult.faceArea.toLocaleString()} –ø–∏–∫—Å–µ–ª–µ–π</p>
                <p><strong>–í–∑–≤–µ—à–µ–Ω–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è:</strong> ${analysisResult.changedPixels.toLocaleString()}</p>
                <p><strong>–û–±–ª–∞—Å—Ç–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π:</strong> ${analysisResult.areasCount}</p>
                <p><strong>–†–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å:</strong> <strong>${analysisResult.similarity.toFixed(1)}%</strong></p>
                <p><strong>–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:</strong> ${analysisResult.analysisTime} —Å–µ–∫</p>
                <p><strong>–ú–µ—Ç–æ–¥:</strong> –í–∑–≤–µ—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –æ–±–ª–∞—Å—Ç–∏ –ª–∏—Ü–∞</p>
                <p>üí° <em>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç–∏ –ª–∏—Ü–∞ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ 3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ</em></p>
            `;

            // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥) ...
        }
    </script>
</body>
</html>
