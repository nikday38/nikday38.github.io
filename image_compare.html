<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compare Pro | Анализ портретов</title>
    <style>
        /* ... (все стили остаются без изменений) ... */
    </style>
</head>
<body>
    <!-- ... (весь HTML код остается без изменений) ... -->

    <script>
        // ... (базовые функции остаются без изменений) ...

        function analyzeImages(sensitivity, minArea) {
            try {
                updateProgress(10, 'Подготовка изображений...');

                const canvas1 = document.createElement('canvas');
                const canvas2 = document.createElement('canvas');
                const ctx1 = canvas1.getContext('2d');
                const ctx2 = canvas2.getContext('2d');

                const width = 800;
                const height = Math.floor((width / image1.naturalWidth) * image1.naturalHeight);

                canvas1.width = canvas2.width = width;
                canvas1.height = canvas2.height = height;

                updateProgress(30, 'Обработка изображений...');
                ctx1.drawImage(image1, 0, 0, width, height);
                ctx2.drawImage(image2, 0, 0, width, height);

                updateProgress(50, 'Детекция лица и анализ...');
                
                const imageData1 = ctx1.getImageData(0, 0, width, height);
                const imageData2 = ctx2.getImageData(0, 0, width, height);
                const data1 = imageData1.data;
                const data2 = imageData2.data;

                // Карта различий
                const diffMap = new Uint8ClampedArray(width * height);
                let totalDifferences = 0;

                // Автоматическое определение области лица (предполагаем центр изображения)
                const faceCenterX = width / 2;
                const faceCenterY = height / 2;
                const faceRadius = Math.min(width, height) * 0.3;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        
                        const r1 = data1[idx];
                        const g1 = data1[idx + 1];
                        const b1 = data1[idx + 2];
                        
                        const r2 = data2[idx];
                        const g2 = data2[idx + 1];
                        const b2 = data2[idx + 2];

                        // Вычисляем цветовую разницу
                        const colorDiff = (
                            Math.abs(r1 - r2) + 
                            Math.abs(g1 - g2) + 
                            Math.abs(b1 - b2)
                        ) / (3 * 255);

                        // Определяем вес пикселя в зависимости от положения
                        let pixelWeight = 1.0;
                        
                        // Проверяем, находится ли пиксель в области лица
                        const distanceToCenter = Math.sqrt(
                            Math.pow(x - faceCenterX, 2) + 
                            Math.pow(y - faceCenterY, 2)
                        );
                        
                        if (distanceToCenter < faceRadius) {
                            // Пиксель в области лица - больший вес
                            pixelWeight = 3.0;
                        } else if (distanceToCenter < faceRadius * 1.5) {
                            // Пиксель рядом с лицом - средний вес
                            pixelWeight = 1.5;
                        }

                        if (colorDiff > sensitivity) {
                            diffMap[y * width + x] = 255;
                            totalDifferences += pixelWeight; // Учитываем вес
                        }
                    }

                    if (y % 10 === 0) {
                        updateProgress(50 + (y / height * 30), `Сканирование: ${Math.round(y / height * 100)}%`);
                    }
                }

                updateProgress(80, 'Поиск значимых областей...');
                
                differenceAreas = findConnectedComponents(diffMap, width, height, minArea);

                updateProgress(90, 'Создание результата...');
                
                const resultCanvas = document.createElement('canvas');
                resultCanvas.width = width;
                resultCanvas.height = height;
                const resultCtx = resultCanvas.getContext('2d');
                
                resultCtx.drawImage(canvas1, 0, 0);

                // Подсвечиваем различия
                resultCtx.strokeStyle = '#ff4757';
                resultCtx.lineWidth = 3;
                resultCtx.fillStyle = 'rgba(255, 71, 87, 0.2)';
                
                // Рисуем область лица для наглядности
                resultCtx.beginPath();
                resultCtx.arc(faceCenterX, faceCenterY, faceRadius, 0, 2 * Math.PI);
                resultCtx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
                resultCtx.stroke();
                
                resultCtx.strokeStyle = '#ff4757';
                
                differenceAreas.forEach(area => {
                    let minX = width, minY = height, maxX = 0, maxY = 0;
                    for (const [x, y] of area) {
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }

                    resultCtx.beginPath();
                    resultCtx.rect(minX, minY, maxX - minX, maxY - minY);
                    resultCtx.stroke();
                    resultCtx.fill();
                });

                // ПРАВИЛЬНЫЙ РАСЧЕТ СХОЖЕСТИ
                const totalPixels = width * height;
                
                // Взвешенная схожесть: учитываем, что изменения в лице важнее
                let weightedSimilarity = 0;
                let maxPossibleWeight = 0;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const distanceToCenter = Math.sqrt(
                            Math.pow(x - faceCenterX, 2) + 
                            Math.pow(y - faceCenterY, 2)
                        );
                        
                        let pixelWeight = 1.0;
                        if (distanceToCenter < faceRadius) {
                            pixelWeight = 3.0;
                        } else if (distanceToCenter < faceRadius * 1.5) {
                            pixelWeight = 1.5;
                        }

                        maxPossibleWeight += pixelWeight;
                        
                        if (diffMap[y * width + x] === 0) {
                            weightedSimilarity += pixelWeight;
                        }
                    }
                }

                const similarity = (weightedSimilarity / maxPossibleWeight) * 100;
                const similarityRounded = Math.max(0, Math.min(100, Math.round(similarity * 10) / 10));

                analysisResult = {
                    similarity: similarityRounded,
                    diffCanvas: resultCanvas,
                    totalPixels: totalPixels,
                    changedPixels: totalDifferences,
                    areasCount: differenceAreas.length,
                    analysisTime: ((Date.now() - startTime) / 1000).toFixed(1),
                    resolution: `${width}×${height}px`,
                    faceArea: Math.round(Math.PI * Math.pow(faceRadius, 2))
                };

                updateProgress(100, 'Анализ завершен!');
                
                setTimeout(() => {
                    document.getElementById('progress-container').style.display = 'none';
                    displayResult();
                }, 500);

            } catch (error) {
                console.error('Analysis error:', error);
                showError('Ошибка анализа: ' + error.message);
                document.getElementById('progress-container').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayResult() {
            if (!analysisResult) return;

            // ... (код отображения результатов) ...

            detailedStats.innerHTML = `
                <p><strong>Область анализа:</strong> ${analysisResult.resolution}</p>
                <p><strong>Область лица:</strong> ${analysisResult.faceArea.toLocaleString()} пикселей</p>
                <p><strong>Взвешенные различия:</strong> ${analysisResult.changedPixels.toLocaleString()}</p>
                <p><strong>Областей изменений:</strong> ${analysisResult.areasCount}</p>
                <p><strong>Реальная схожесть:</strong> <strong>${analysisResult.similarity.toFixed(1)}%</strong></p>
                <p><strong>Время анализа:</strong> ${analysisResult.analysisTime} сек</p>
                <p><strong>Метод:</strong> Взвешенный анализ с приоритетом области лица</p>
                <p>💡 <em>Изменения в области лица учитываются в 3 раза больше</em></p>
            `;

            // ... (остальной код) ...
        }
    </script>
</body>
</html>
